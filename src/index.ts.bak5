// CRITICAL: Load environment variables FIRST before any other imports
import dotenv from "dotenv";
dotenv.config();

import express from "express";
import cors from "cors";
import helmet from "helmet";
import cookieParser from "cookie-parser";
import { testDatabaseConnection } from "./config/database";
import { globalRateLimiter, authRateLimiter } from "./middleware/rateLimit";
import { createAuditLogsTable } from "./utils/auditLog";
import { tokenBlacklistDb } from "./utils/tokenBlacklistDb";

import articlesRouter from "./routes/articles";
import commentsRouter from "./routes/comments";
import authorsRouter from "./routes/authors";
import categoriesRouter from "./routes/categories";
import tagsRouter from "./routes/tags";
import trendingRouter from "./routes/trending";
import relatedRouter from "./routes/related";
import searchRouter from "./routes/search";
import articleLikesRouter from "./routes/article-likes";

import adminCommentsRouter from "./routes/admin/comments";
import adminAuthorsRouter from "./routes/admin/authors";
import adminCategoriesRouter from "./routes/admin/categories";
import adminTagsRouter from "./routes/admin/tags";
import authRouter from "./routes/auth";
import passport from "passport";
import usersRouter from "./routes/users";
import adminArticlesRouter from "./routes/admin/articles";
import adminArticleIdeasRouter from "./routes/admin/article-ideas";

const app = express();
const PORT = parseInt(process.env.PORT || "3001", 10);

app.set("trust proxy", true);

const allowedOrigins = (process.env.ALLOWED_ORIGINS || "http://localhost:3000")
  .split(",")
  .map((o) => o.trim());

app.use((req, res, next) => {
  const origin = req.get("origin");
  const userAgent = req.get("user-agent") || "";

  if (!origin) {
    const host = req.get("host");

    if (process.env.NODE_ENV === "production") {
      if (host?.includes("fly.dev") || userAgent.includes("Next.js")) {
        res.header("Access-Control-Allow-Origin", allowedOrigins[0]);
        res.header(
          "Access-Control-Allow-Methods",
          "GET, POST, PUT, DELETE, OPTIONS",
        );
        res.header(
          "Access-Control-Allow-Headers",
          "Origin, X-Requested-With, Content-Type, Accept, Authorization",
        );
        if (req.method === "OPTIONS") {
          return res.sendStatus(200);
        }
        return next();
      }
      return res.status(403).json({ error: "Origin required" });
    }

    res.header("Access-Control-Allow-Origin", allowedOrigins[0]);
    res.header(
      "Access-Control-Allow-Methods",
      "GET, POST, PUT, DELETE, OPTIONS",
    );
    res.header(
      "Access-Control-Allow-Headers",
      "Origin, X-Requested-With, Content-Type, Accept, Authorization",
    );
    if (req.method === "OPTIONS") {
      return res.sendStatus(200);
    }
    return next();
  }

  if (allowedOrigins.includes(origin)) {
    res.header("Access-Control-Allow-Origin", origin);
    res.header("Access-Control-Allow-Credentials", "true");
    res.header(
      "Access-Control-Allow-Methods",
      "GET, POST, PUT, DELETE, OPTIONS",
    );
    res.header(
      "Access-Control-Allow-Headers",
      "Origin, X-Requested-With, Content-Type, Accept, Authorization",
    );
    if (req.method === "OPTIONS") {
      return res.sendStatus(200);
    }
    return next();
  }

  console.warn(`[CORS] Blocked request from unauthorized origin: ${origin}`);
  return res.status(403).json({ error: "Not allowed by CORS" });
});

app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        scriptSrc: ["'self'"],
        styleSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"],
        connectSrc: ["'self'"],
        fontSrc: ["'self'"],
        objectSrc: ["'none'"],
        mediaSrc: ["'self'"],
        frameSrc: ["'none'"],
      },
    },
    crossOriginEmbedderPolicy: false,
    crossOriginResourcePolicy: { policy: "cross-origin" },
    hsts: {
      maxAge: 31536000,
      includeSubDomains: true,
      preload: true,
    },
    frameguard: { action: "deny" },
    noSniff: true,
    referrerPolicy: { policy: "strict-origin-when-cross-origin" },
  }),
);

// Additional security headers
app.use((req, res, next) => {
  res.setHeader(
    "Permissions-Policy",
    "geolocation=(), microphone=(), camera=()",
  );
  next();
});

app.use(express.json({ limit: "1mb" }));
app.use(express.urlencoded({ extended: true, limit: "1mb" }));
app.use(cookieParser());
app.use(passport.initialize());
app.use(globalRateLimiter);

app.use((req, res, next) => {
  console.log(`ğŸ“¥ ${req.method} ${req.path}`);
  next();
});

app.get("/health", (req, res) => {
  res.json({ status: "ok", timestamp: new Date().toISOString() });
});

app.use("/api/articles", articlesRouter);
app.use("/api/comments", commentsRouter);
app.use("/api/authors", authorsRouter);
app.use("/api/categories", categoriesRouter);
app.use("/api/tags", tagsRouter);
app.use("/api/auth", authRateLimiter, authRouter);
app.use("/api/users", usersRouter);
app.use("/api/trending", trendingRouter);
app.use("/api/related", relatedRouter);
app.use("/api/search", searchRouter);
app.use("/api/article-likes", articleLikesRouter);

app.use("/api/admin/articles", adminArticlesRouter);
app.use("/api/admin/article-ideas", adminArticleIdeasRouter);
app.use("/api/admin/comments", adminCommentsRouter);
app.use("/api/admin/authors", adminAuthorsRouter);
app.use("/api/admin/categories", adminCategoriesRouter);
app.use("/api/admin/tags", adminTagsRouter);

app.use((req, res) => {
  res.status(404).json({ error: "Endpoint not found" });
});

app.use(
  (
    err: any,
    req: express.Request,
    res: express.Response,
    next: express.NextFunction,
  ) => {
    console.error("Error occurred:", {
      message: err.message,
      stack: process.env.NODE_ENV !== "production" ? err.stack : undefined,
      path: req.path,
      method: req.method,
      timestamp: new Date().toISOString(),
    });

    const statusCode = err.statusCode || err.status || 500;

    if (process.env.NODE_ENV === "production") {
      const safeMessages: { [key: number]: string } = {
        400: "Bad request",
        401: "Unauthorized",
        403: "Forbidden",
        404: "Not found",
        429: "Too many requests",
        500: "Internal server error",
        503: "Service unavailable",
      };

      return res.status(statusCode).json({
        error: safeMessages[statusCode] || "An error occurred",
      });
    }

    res.status(statusCode).json({
      error: err.message || "An error occurred",
      ...(process.env.NODE_ENV === "development" && {
        stack: err.stack,
        details: err.details,
      }),
    });
  },
);

async function start() {
  try {
    const dbConnected = await testDatabaseConnection();
    if (!dbConnected) {
      console.error("Failed to connect to database. Exiting...");
      process.exit(1);
    }

    await createAuditLogsTable();
    await tokenBlacklistDb.init();

    app.listen(PORT, "0.0.0.0", () => {
      console.log(`ğŸš€ Server running on port ${PORT}`);
      console.log(`ğŸ“ Environment: ${process.env.NODE_ENV || "development"}`);
      console.log(`ğŸŒ Allowed origins: ${allowedOrigins.join(", ")}`);
      console.log(
        `ğŸ”’ Security: Enhanced headers, token rotation, audit logging enabled`,
      );
    });
  } catch (error) {
    console.error("Failed to start server:", error);
    process.exit(1);
  }
}

start();
